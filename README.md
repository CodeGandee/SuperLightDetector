# YOLO微调训练项目 - 优化版本

本项目使用YOLOv8n模型对自定义小数据集进行微调训练，支持记录训练损失和生成混淆矩阵。针对小数据集进行了参数优化。

## 数据集说明

数据集包含4个类别：
- FLIGHT (飞行)
- TURNLEFT (左转)
- PARKING (停车)
- TURNROUND (掉头)

### 数据集分布（已优化）
- **训练集**: 35张图片 (68.6%)
- **验证集**: 10张图片 (19.6%)
- **测试集**: 6张图片 (11.8%)
- **总计**: 51张图片

## 环境设置

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 数据集结构
确保数据集按照以下结构组织：
```
label_data_PRTest/
├── label_data_dataset/
│   ├── images/
│   │   ├── train/     # 训练图片 (35张)
│   │   ├── val/       # 验证图片 (10张)
│   │   └── test/      # 测试图片 (6张)
│   └── labels/
│       ├── train/     # 训练标签 (35个)
│       ├── val/       # 验证标签 (10个)
│       └── test/      # 测试标签 (6个)
├── script/
│   ├── train_yolo.py
│   ├── reorganize_simple.py
│   └── label_data.yaml
└── reorganize.sh
```

## 数据集重新划分

如果需要重新划分数据集，可以使用以下方法：

### 方法1: 使用bash脚本（推荐）
```bash
cd label_data_PRTest
chmod +x reorganize.sh
./reorganize.sh
```

### 方法2: 使用Python脚本
```bash
cd label_data_PRTest/script
python reorganize_simple.py
```

## 使用方法

### 1. 运行训练
```bash
cd label_data_PRTest/script
python train_yolo.py
```

### 2. 训练参数说明（针对小数据集优化）

#### 基础参数
- **epochs**: 200轮训练（增加以充分学习小数据集）
- **imgsz**: 640像素图片大小
- **device**: CPU训练（可修改为'0'使用GPU）
- **batch**: 4（小batch size适合小数据集，避免过拟合）

#### 学习率参数
- **lr0**: 0.001（降低初始学习率）
- **lrf**: 0.1（最终学习率因子）
- **momentum**: 0.9
- **weight_decay**: 0.0005
- **optimizer**: AdamW（适合小数据集）

#### 数据增强参数（适度增强）
- **hsv_h**: 0.015（色调增强）
- **hsv_s**: 0.7（饱和度增强）
- **hsv_v**: 0.4（明度增强）
- **fliplr**: 0.5（水平翻转概率）
- **translate**: 0.1（平移增强）
- **scale**: 0.5（缩放增强）
- **mosaic**: 1.0（mosaic增强）

#### 其他优化
- **warmup_epochs**: 5（预热轮数）
- **close_mosaic**: 10（最后10轮关闭mosaic增强）
- **amp**: False（CPU训练关闭混合精度）

## 训练输出

训练完成后，以下文件将保存在 `training_outputs/` 目录中：

### 1. 训练指标可视化
- **training_curves_optimized.png**: 包含4个子图的训练指标图
  - 边界框损失 (训练vs验证)
  - 分类损失 (训练vs验证)
  - mAP指标 (mAP@0.5 和 mAP@0.5:0.95)
  - 精确度和召回率

### 2. 模型文件
- **best.pt**: 最佳模型权重
- **last.pt**: 最后一轮训练的模型权重
- **模型.onnx**: 导出的ONNX格式模型

### 3. 评估结果
- **confusion_matrix.png**: 混淆矩阵
- **results.csv**: 详细的训练指标数据
- **final_metrics.txt**: 最终指标摘要
- **val_batch*.jpg**: 验证批次的预测结果可视化

### 4. 训练日志
- 控制台输出包含实时训练进度
- 验证集和测试集性能指标
- 最终的mAP、精确度、召回率

## 监控训练进度

脚本会在训练过程中显示：
- 每轮的损失值
- 验证集性能指标
- 测试集性能指标
- 最终的mAP、精确度、召回率对比

## 小数据集训练建议

### 1. 参数调优建议
- **batch size**: 保持较小值（2-8），避免过拟合
- **学习率**: 使用较低的初始学习率
- **epochs**: 增加训练轮数，但注意监控过拟合
- **数据增强**: 适度使用，避免过度增强

### 2. 监控过拟合
- 观察训练损失vs验证损失的差距
- 如果验证损失开始上升，考虑早停
- 使用权重衰减和dropout防止过拟合

### 3. 模型选择
- YOLOv8n适合小数据集，参数量较少
- 可以考虑冻结部分层进行微调
- 使用预训练权重提高收敛速度

## 自定义配置

可以在 `train_yolo.py` 中修改以下参数：
- `epochs`: 训练轮数
- `batch`: 批次大小
- `lr0`: 初始学习率
- `optimizer`: 优化器选择
- 数据增强参数
- 其他训练超参数

## 注意事项

1. **小数据集特点**: 51张图片属于小数据集，需要特别注意过拟合
2. **数据质量**: 确保标注质量，小数据集中每个样本都很重要
3. **验证策略**: 使用分层采样确保各类别在训练/验证/测试集中均匀分布
4. **GPU加速**: 建议使用GPU加速训练（修改device参数为'0'）
5. **模型保存**: 训练过程中会自动保存最佳模型

## 故障排除

如果遇到问题：
1. 检查数据集路径是否正确
2. 确认所有依赖已正确安装
3. 验证图片和标签文件是否匹配
4. 检查数据集划分是否合理
5. 监控训练过程中的内存使用

## 性能评估

训练完成后，脚本会自动生成：
- 验证集性能报告
- 测试集性能报告
- 混淆矩阵分析
- 各类别的精确度和召回率 